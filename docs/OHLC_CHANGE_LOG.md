# OHLC 데이터 수집 설정 변경

## 📅 변경 일시
- 2025-11-30 17:10

---

## 🔄 변경 내역

### 1. 수정주가 적용
**변경**: `sujung: "N"` → `sujung: "Y"`

**이유**:
- 액면분할, 배당 등 반영
- 차트 연속성 확보
- 기술적 분석 정확도 향상

**영향**:
- 백테스트 결과 변경 가능
- 과거 가격이 조정됨
- 실제 거래가격과 다를 수 있음

### 2. 거래소 구분 변경
**변경**: `exchgubun: "K"` → `exchgubun: "U"`

**거래소 구분 코드**:
- `K`: KRX (한국거래소)
- `N`: NXT (넥스트)
- `U`: 통합 (모든 거래소)

**이유**:
- 통합 데이터 조회
- 더 넓은 범위 커버

### 3. 기존 데이터 삭제
**삭제된 데이터**: 614개
- 000660: 121개
- 005930: 4개
- 035420: 121개
- 069500: 121개
- 122630: 121개
- 252670: 121개
- 0126Z0: 5개

**이유**:
- 수정주가 적용으로 데이터 불일치 방지
- 깨끗한 재시작

---

## 📊 수정주가 vs 비수정주가

### 비수정주가 (기존)
```
2024-01-01: 100,000원
2024-06-01: 액면분할 (1:2)
2024-06-02: 50,000원  ← 실제 거래가격
```

### 수정주가 (변경 후)
```
2024-01-01: 50,000원  ← 과거 가격 조정
2024-06-01: 액면분할 (1:2)
2024-06-02: 50,000원  ← 실제 거래가격
```

**차트 비교**:
- 비수정주가: 차트에 단절 발생 (100k → 50k)
- 수정주가: 연속적인 차트 (50k → 50k)

---

## 🎯 적용된 코드

### broker/ls/services/market.py

#### get_daily_ohlc (일봉)
```python
"t8451InBlock": {
    "shcode": symbol,
    "gubun": "2",
    "qrycnt": 500,
    "sdate": start_date.strftime("%Y%m%d"),
    "edate": end_date.strftime("%Y%m%d"),
    "cts_date": "",
    "comp_yn": "N",
    "sujung": "Y",      # ✅ 수정주가 적용
    "exchgubun": "U"    # ✅ 통합 거래소
}
```

#### get_minute_ohlc (분봉)
```python
"t8452InBlock": {
    "shcode": symbol,
    "ncnt": interval,
    "qrycnt": count,
    "nday": "1",
    "sdate": "",
    "stime": "",
    "edate": "",
    "etime": "",
    "cts_date": "",
    "cts_time": "",
    "comp_yn": "N",
    "exchgubun": "U"    # ✅ 통합 거래소
}
```

#### get_top_volume_stocks (거래대금 상위)
```python
"t1463InBlock": {
    "gubun": market,
    "jnilgubun": "1",
    "jc_num": 0,
    "sprice": 0,
    "eprice": 0,
    "volume": 0,
    "idx": 0,
    "jc_num2": 0,
    "exchgubun": "U"    # ✅ 통합 거래소
}
```

---

## 🧪 테스트 방법

### 1. 단일 종목 테스트
```bash
# 005930 데이터 수집 (180일)
python scripts/fetch_ohlc_data.py --symbol 005930 --days 180
```

**예상 결과**:
- 약 120~130개 일봉 데이터 수집
- 수정주가 적용됨
- exchgubun = "U"로 조회

### 2. 대량 수집 테스트
```bash
# 상위 50종목, 180일
python scripts/fetch_ohlc_data.py --count 50 --days 180
```

**예상 소요 시간**: 5-10분

### 3. API 테스트
```bash
# 데이터 수집 API
POST /api/data/collect/start
{
  "count": 10,
  "days": 90
}
```

### 4. 차트 확인
1. 브라우저: http://localhost:3000/dashboard
2. 종목 입력: `005930`
3. 차트 표시 확인
4. 수정주가 적용 확인 (연속적인 차트)

---

## 📈 예상 효과

### 긍정적 효과
1. **차트 연속성**: 액면분할 시에도 매끄러운 차트
2. **백테스트 정확도**: 수정주가로 정확한 수익률 계산
3. **기술적 분석**: 이동평균선 등 지표 정확도 향상
4. **통합 데이터**: 여러 거래소 데이터 통합 조회

### 주의사항
1. **실제 거래가격과 차이**: 수정주가는 과거 가격이 조정됨
2. **주문 시 주의**: 실제 주문은 현재가 기준
3. **데이터 재수집 필요**: 기존 데이터 삭제됨

---

## 🔄 롤백 방법

변경사항을 되돌리려면:

```python
# broker/ls/services/market.py
"sujung": "N",      # Y → N
"exchgubun": "K"    # U → K
```

그리고 데이터 재수집:
```bash
python scripts/fetch_ohlc_data.py --count 200 --days 180
```

---

## ✅ 체크리스트

- [x] API 파라미터 수정 (sujung: Y, exchgubun: U)
- [x] 기존 데이터 삭제 (614개)
- [ ] 데이터 재수집
- [ ] 차트 확인
- [ ] 백테스트 재실행
- [ ] 결과 비교

---

**변경 완료**: 2025-11-30 17:10
**상태**: ✅ 코드 수정 완료, 데이터 재수집 대기
**다음 단계**: 데이터 수집 실행
