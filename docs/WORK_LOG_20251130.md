# 작업 로그 - 2025년 11월 30일

## 완료된 작업

### 1. 거래대금 표시 오류 수정
**문제**: 웹 UI에서 거래대금이 모두 0억으로 표시
**원인**: LS증권 API `t1463`의 `jnilvalue` 필드가 백만원 단위로 반환
**해결**:
- `broker/ls/services/market.py`에서 백만원 → 원 단위 변환 (`x 1,000,000`)
- `scripts/fix_volume_amount.py` 스크립트로 기존 DB 데이터 일괄 수정
- 웹 UI에서 컴마 포맷팅 추가 (`toLocaleString()`)

**결과**: 거래대금이 "36,669억" 형식으로 정상 표시

---

### 2. 종목 수집 개수 제한 해결 (50개 → 500개)
**문제**: t1463 API가 한 번에 50개만 반환
**해결**: 연속조회 구현
- `idx` 파라미터로 다음 페이지 조회
- `tr_cont: "Y"`로 연속조회 플래그 설정
- 원하는 개수만큼 반복 조회

**코드**:
```python
# broker/ls/services/market.py - get_top_volume_stocks()
while len(stocks) < count:
    response = await self.client.request(
        headers={"tr_cont": "Y" if idx > 0 else "N"}
    )
    idx = response.get("t1463OutBlock", {}).get("idx", 0)
```

---

### 3. 일봉 데이터 수집 기간 제한 해결 (203일 → 무제한)
**문제**: t8451 API가 한 번에 약 200일치만 반환
**시도**: 연속조회(`cts_date`, `tr_cont_key`) → 실패 (API 미지원)
**해결**: 기간을 200일씩 나눠서 여러 번 조회

**코드**:
```python
# broker/ls/services/market.py - get_daily_ohlc()
chunk_days = 200
while current_end >= start_date:
    current_start = max(current_end - timedelta(days=chunk_days), start_date)
    # API 호출
    current_end = current_start - timedelta(days=1)
```

**결과**: 300일 요청 시 2번 조회 (200일 + 100일)

---

### 4. 시장 구분 정확도 개선
**문제**: 수집된 종목이 모두 KOSPI로 표시
**원인**: t1463 API 응답에 시장 구분 필드 없음
**해결**:
- 데이터 수집 시작 시 t8436 API로 전체 종목 정보 조회
- `symbol → market` 매핑 테이블 생성
- 각 종목 저장 시 매핑 테이블에서 정확한 시장 구분 조회

**코드**:
```python
# api/routes/data_collection.py
all_symbols = await adapter.market_service.get_all_symbols(market="0")
symbol_market_map = {s["symbol"]: s["market"] for s in all_symbols}
market = "KOSPI" if symbol_market_map.get(symbol) == "1" else "KOSDAQ"
```

---

### 5. 페이지네이션 추가
**기능**: 수집된 종목 목록을 50개씩 페이지 단위로 표시
**구현**:
- 프론트엔드: 페이지 상태 관리, 이전/다음 버튼
- 백엔드: `limit`, `offset` 파라미터 지원

**UI**:
```
◀ 이전  |  1 / 5 페이지 (총 250개)  |  다음 ▶
```

---

### 6. 중복 데이터 처리 개선
**문제**: DB 저장 시 중복 키 에러 발생
```
duplicate key value violates unique constraint "ohlc_data_symbol_interval_timestamp_key"
```

**해결**: `save_ohlc_batch()` 함수 수정
- 기존 데이터 확인 후 업데이트 또는 추가
- `session.no_autoflush` 블록으로 autoflush 에러 방지

**코드**:
```python
# data/repository.py
with session.no_autoflush:
    existing = session.query(OHLCModel).filter_by(...).first()
    if existing:
        # 업데이트
    else:
        # 추가
```

---

### 7. 영업일 기준 데이터 수집
**문제**: 300일 요청 시 203개만 수집 (달력 기준)
**해결**: 영업일 기준으로 변환
- 요청 일수 × 1.5배 기간 조회 (주말/공휴일 고려)
- 수집된 데이터 중 최신 N개만 사용

**코드**:
```python
# api/routes/data_collection.py
calendar_days = int(days * 1.5)
start_date = end_date - timedelta(days=calendar_days)
if len(ohlc_list) > days:
    ohlc_list = ohlc_list[-days:]  # 최신 N개
```

**결과**: 300일 요청 시 약 296~300개 수집

---

## 생성된 파일

1. `scripts/fix_volume_amount.py` - 거래대금 단위 수정 스크립트
2. `scripts/clear_collected_data.py` - 수집 데이터 삭제 스크립트
3. `scripts/test_ohlc_continuous.py` - 일봉 연속조회 테스트
4. `scripts/test_qrycnt_only.py` - qrycnt 파라미터 테스트

---

## 수정된 파일

1. `broker/ls/services/market.py`
   - 거래대금 백만원 → 원 단위 변환
   - 종목 수집 연속조회 구현
   - 일봉 데이터 기간 분할 조회

2. `api/routes/data_collection.py`
   - 시장 구분 매핑 추가
   - 영업일 기준 데이터 수집

3. `data/repository.py`
   - 중복 데이터 처리 개선

4. `frontend/src/pages/DataCollection.tsx`
   - 거래대금 컴마 포맷팅
   - 페이지네이션 UI 추가

5. `docs/API_IMPLEMENTATION.md`
   - t1463 API 거래대금 단위 명시

---

## 주요 발견 사항

### LS증권 API 제약사항
1. **t1463 (거래대금상위)**
   - 한 번에 50개만 반환
   - 연속조회 필요 (`idx` 파라미터)
   - `jnilvalue`는 백만원 단위

2. **t8451 (일봉차트)**
   - 한 번에 약 200일치만 반환
   - 연속조회(`cts_date`) 미지원
   - 기간 분할 조회 필요

3. **t8436 (종목조회)**
   - 시장 구분 정보 포함
   - 전체 종목 조회 가능 (4,212개)

---

## 다음 단계

1. ✅ 데이터 수집 시스템 완성
2. ⏳ 백테스트 엔진 구현
3. ⏳ 전략 개발 (평균회귀/모멘텀)
4. ⏳ 실시간 트레이딩 시스템

---

## 테스트 결과

- 종목 수집: 10개 → 정상 (연속조회 작동)
- 일봉 수집: 296개 → 정상 (300일 요청)
- 시장 구분: KOSPI/KOSDAQ 정확히 표시
- 페이지네이션: 50개씩 정상 표시
- 중복 처리: 에러 없이 업데이트
